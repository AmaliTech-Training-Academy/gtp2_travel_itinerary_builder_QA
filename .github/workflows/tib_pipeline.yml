name: Travel Itinerary QA Automation Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ------------------------
  # 1. UI TESTS (Selenide + Cucumber BDD)
  # ------------------------
#  ui-tests:
#    name: üß™ UI Tests
#    runs-on: ubuntu-latest
#    continue-on-error: false
#
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v4
#
#      - name: Build Docker image for tests
#        run: docker build -t travel_ui_tests .
#
#      - name: Run UI tests with Docker Compose
#        run: docker compose up --build --abort-on-container-exit --exit-code-from tests
#        env:
#          COMPOSE_FILE: docker-compose.yml
#
#      - name: Upload Allure results
#        if: always()
#        uses: actions/upload-artifact@v4
#        with:
#          name: allure-results
#          path: allure-results
#
#      - name: Upload Cucumber JSON results
#        if: always()
#        uses: actions/upload-artifact@v4
#        with:
#          name: cucumber-json
#          path: target/cucumber.json

  # ------------------------
  # 2. API TESTS (Rest Assured)
  # ------------------------
  api-tests:
    name: üõ†Ô∏è API Tests
    runs-on: ubuntu-latest
#    needs: ui-tests
    continue-on-error: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image for API tests
        run: docker build -t travel_api_tests .

      - name: Run API tests
        run: docker run --rm -v ${{ github.workspace }}:/app travel_api_tests mvn test

      - name: Upload API Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-allure-results
          path: allure-results

  # ------------------------
  # 3. BACKEND PERFORMANCE (JMeter)
  # ------------------------
  backend-performance:
    name: ‚ö° Backend Performance (JMeter)
    runs-on: ubuntu-latest
    needs: api-tests
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run JMeter API test plan
        run: |
          mkdir -p jmeter-results
          docker run --rm -v ${{ github.workspace }}:/jmeter \
            justb4/jmeter \
            -n -t /performance/backend/TIB_API_Backend_Performance_Test_Plan.jmx  \
            -l /jmeter/jmeter-results/results.jtl \
#            -e -o /jmeter/jmeter-results/html-report

      - name: Upload JMeter results
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results
          path: jmeter-results

#  # ------------------------
#  # 4. FRONTEND PERFORMANCE (Optional Lighthouse)
#  # ------------------------
#  frontend-performance:
#    name: üåê Frontend Performance (Lighthouse)
#    runs-on: ubuntu-latest
#    needs: ui-tests
#    if: always()
#
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v4
#
#      - name: Install Lighthouse CI
#        run: npm install -g @lhci/cli@0.11.x
#
#      - name: Run Lighthouse against deployed app
#        run: |
#          lhci collect --url=https://your-staging-frontend-url.com --upload=false --outDir=frontend-performance
#          lhci report --outputDir=frontend-performance
#
#      - name: Upload Frontend Performance results
#        uses: actions/upload-artifact@v4
#        with:
#          name: frontend-performance
#          path: frontend-performance
#
#  # ------------------------
#  # 5. BACKEND SECURITY (OWASP ZAP)
#  # ------------------------
#  backend-security:
#    name: üîí Backend Security Scan
#    runs-on: ubuntu-latest
#    needs: api-tests
#    if: always()
#
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v4
#
#      - name: Prepare security report folder
#        run: mkdir -p security/backend-security
#
#      - name: Run ZAP Baseline Scan against API
#        run: |
#          docker run --rm -v ${{ github.workspace }}/security/backend-security:/zap/wrk:rw \
#            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
#            -t https://your-api-staging-url.com \
#            -r zap-api-report.html \
#            -J zap-api-report.json
#
#      - name: Upload ZAP API Report
#        uses: actions/upload-artifact@v4
#        with:
#          name: backend-security-report
#          path: security/backend-security
#
#  # ------------------------
#  # 6. FRONTEND SECURITY (OWASP ZAP)
#  # ------------------------
#  frontend-security:
#    name: üîí Frontend Security Scan
#    runs-on: ubuntu-latest
#    needs: ui-tests
#    if: always()
#
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v4
#
#      - name: Prepare security report folder
#        run: mkdir -p security/frontend-security
#
#      - name: Run ZAP Baseline Scan against frontend
#        run: |
#          docker run --rm -v ${{ github.workspace }}/security/frontend-security:/zap/wrk:rw \
#            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
#            -t https://your-frontend-staging-url.com \
#            -r zap-frontend-report.html \
#            -J zap-frontend-report.json
#
#      - name: Upload ZAP Frontend Report
#        uses: actions/upload-artifact@v4
#        with:
#          name: frontend-security-report
#          path: security/frontend-security
#
#  # ------------------------
#  # 7. AGGREGATE ALL REPORTS
#  # ------------------------
#  aggregate-reports:
#    name: üìä Aggregate All Reports
#    runs-on: ubuntu-latest
#    needs: [ui-tests, api-tests, backend-performance, frontend-performance, backend-security, frontend-security]
#    if: always()
#
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v4
#
#      - name: Download All Artifacts
#        uses: actions/download-artifact@v4
#        with:
#          name: allure-results
#          path: reports/allure
#      - uses: actions/download-artifact@v4
#        with:
#          name: api-allure-results
#          path: reports/api-allure
#      - uses: actions/download-artifact@v4
#        with:
#          name: cucumber-json
#          path: reports/cucumber-json
#      - uses: actions/download-artifact@v4
#        with:
#          name: jmeter-results
#          path: reports/jmeter
#      - uses: actions/download-artifact@v4
#        with:
#          name: frontend-performance
#          path: reports/frontend-performance
#      - uses: actions/download-artifact@v4
#        with:
#          name: backend-security-report
#          path: reports/backend-security
#      - uses: actions/download-artifact@v4
#        with:
#          name: frontend-security-report
#          path: reports/frontend-security
#
#      - name: Generate Allure HTML report
#        run: |
#          wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
#          tar -xzf allure-2.27.0.tgz
#          sudo mv allure-2.27.0 /opt/allure
#          sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure
#          allure generate reports/allure --clean -o reports/allure-report
#
#      - name: Generate Cucumber HTML report
#        run: |
#          npm init -y
#          npm install cucumber-html-reporter --save-dev
#          node -e "
#            const reporter = require('cucumber-html-reporter');
#            reporter.generate({
#              theme: 'bootstrap',
#              jsonFile: 'reports/cucumber-json/cucumber.json',
#              output: 'reports/cucumber-report/index.html',
#              reportSuiteAsScenarios: true,
#              launchReport: false
#            });
#          "
#
#  # ------------------------
  # 8. DEPLOY REPORTS
  # ------------------------
#  deploy-reports:
#    name: üöÄ Deploy Reports to GitHub Pages
#    runs-on: ubuntu-latest
##    needs: aggregate-reports
#    if: always()
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Deploy all reports
#        uses: peaceiris/actions-gh-pages@v4
#        with:
#          github_token: ${{ secrets.GITHUB_TOKEN }}
#          publish_dir: reports
#          publish_branch: gh-pages
#          force_orphan: true
#
#  # ------------------------
#  # 9. SLACK NOTIFICATION
#  # ------------------------
#  notify:
#    name: üîî Slack Notification
#    runs-on: ubuntu-latest
#    needs: [ui-tests, api-tests, backend-performance, frontend-performance, backend-security, frontend-security, aggregate-reports, deploy-reports]
#    if: always()
#
#    steps:
#      - name: Send Slack notification
#        run: |
#          STATUS="success"
#          COLOR="good"
#          EMOJI="‚úÖ"
#          TITLE="*Travel Itinerary QA Pipeline Passed*"
#
#          if [[ "${{ needs.ui-tests.result }}" == "failure" || \
#                "${{ needs.api-tests.result }}" == "failure" || \
#                "${{ needs.backend-performance.result }}" == "failure" || \
#                "${{ needs.frontend-performance.result }}" == "failure" || \
#                "${{ needs.backend-security.result }}" == "failure" || \
#                "${{ needs.frontend-security.result }}" == "failure" ]]; then
#            STATUS="completed_with_failures"
#            COLOR="warning"
#            EMOJI="‚ö†Ô∏è"
#            TITLE="*Travel Itinerary QA Pipeline Completed with Failures*"
#          fi
#
#          curl -X POST -H 'Content-type: application/json' --data "{
#            \"text\": \"$EMOJI $TITLE\nStatus: $STATUS\"
#          }" ${{ secrets.SLACK_WEBHOOK_URL }}
